# –°–µ—Ä–≤–∏—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (auth)
## –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
## –°–µ—Ä–≤–∏—Å auth –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ. –û–Ω —Ä–µ–∞–ª–∏–∑—É–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º—ã:

1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
2. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ –ª–æ–≥–∏–Ω—É –∏ –ø–∞—Ä–æ–ª—é (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ second_login, email, phone)  
3. –í—ã–¥–∞—á–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è JWT-—Ç–æ–∫–µ–Ω–æ–≤ (access + refresh)  
4. –ë–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è refresh-—Ç–æ–∫–µ–Ω–æ–≤  
5. –°–µ—Ä–≤–∏—Å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å –æ–±—â–µ–π –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö mydb, –∏—Å–ø–æ–ª—å–∑—É—è –¥–≤–µ —Å—Ö–µ–º—ã:  

   - accounts ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏ –≥—Ä—É–ø–ø (—á–µ—Ä–µ–∑ –≤—ã–∑–æ–≤ —Ö—Ä–∞–Ω–∏–º—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π)  
   -   auth ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ refresh-—Ç–æ–∫–µ–Ω–æ–≤ –∏ —Å–µ—Å—Å–∏–æ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
### üìå –°–µ—Ä–≤–∏—Å –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç ORM, –Ω–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—è–º–∏, –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –≤—ã–∑–æ–≤—ã —Ñ—É–Ω–∫—Ü–∏–π PostgreSQL. 

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã  
1. –ß—ë—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∑–æ–Ω –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:  
   - accounts ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏ –≥—Ä—É–ø–ø (—á–µ—Ä–µ–∑ –≤—ã–∑–æ–≤ —Ö—Ä–∞–Ω–∏–º—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π)    
   - auth ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ refresh-—Ç–æ–∫–µ–Ω–æ–≤ –∏ —Å–µ—Å—Å–∏–æ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö   
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ DOT (Data Transfer Object): –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JSON-–æ–±—ä–µ–∫—Ç—ã  
3. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ refresh-—Ç–æ–∫–µ–Ω–∞ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏  
4. –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å: –ª–æ–≥–∏–∫–∞ auth –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü accounts  
5. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:  
   - –ü–∞—Ä–æ–ª–∏ —Ö–µ—à–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ bcrypt  
   - Refresh-—Ç–æ–∫–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ (SHA-256)  
   - Access-—Ç–æ–∫–µ–Ω—ã ‚Äî JWT —Å HS256  

## –°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π

    - –Ø–∑—ã–∫: Python 3.12+
    - –§—Ä–µ–π–º–≤–æ—Ä–∫: FastAPI
    - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: PostgreSQL (—á–µ—Ä–µ–∑ asyncpg)
    - JWT: PyJWT + passlib
    - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: loguru
    - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: pydantic-settings + .env

## –°—Ö–µ–º–∞ –ë–î: auth
| –¢–∞–±–ª–∏—Ü–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|--------|-----------|
| `refresh_tokens` | –•—Ä–∞–Ω–µ–Ω–∏–µ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö refresh-—Ç–æ–∫–µ–Ω–æ–≤ —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ `user_id` –∏ —Å—Ä–æ–∫–æ–º –¥–µ–π—Å—Ç–≤–∏—è |  

### –•—Ä–∞–Ω–∏–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ —Å—Ö–µ–º–µ auth
| –§—É–Ω–∫—Ü–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|--------|
| `auth.create_refresh_token(user_id UUID, token_hash TEXT, expires_at TIMESTAMPTZ)` | –°–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å—å –æ refresh-—Ç–æ–∫–µ–Ω–µ |
| `auth.consume_refresh_token(token_hash TEXT)` | –ü–æ–º–µ—á–∞–µ—Ç —Ç–æ–∫–µ–Ω –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `user_id` |

### –û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
POST /api/v1/auth/login
–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ –ª–æ–≥–∏–Ω—É –∏ –ø–∞—Ä–æ–ª—é.

### –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:
```commandline
{
  "login": "john_doe",
  "password": "SecurePass123!"
}
```
### –û—Ç–≤–µ—Ç:
```commandline
{
  "access_token": "eyJ...",
  "refresh_token": "r3fr3sh-t0k3n...",
  "token_type": "bearer"
}
```
### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã –ª–æ–≥–∏–Ω–∞:
    - second_login (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ª–æ–≥–∏–Ω)
    - Email (–Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É)
    - –¢–µ–ª–µ—Ñ–æ–Ω (–Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è –∫ —Ñ–æ—Ä–º–∞—Ç—É +7...)
POST /api/v1/auth/refresh
–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ access-—Ç–æ–∫–µ–Ω–∞ –ø–æ refresh-—Ç–æ–∫–µ–Ω—É.

### –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:
```commandline
{
  "refresh_token": "r3fr3sh-t0k3n..."
}
```
### –û—Ç–≤–µ—Ç:
```commandline
{
  "access_token": "new-jwt...",
  "refresh_token": "",
  "token_type": "bearer"
}
```
POST /api/v1/auth/register (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ / —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)  

–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ–ª–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π.

### –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:
```commandline
{
  "second_login": "john_doe",
  "phone": "+79991234567",
  "email": "john@example.com",
  "password": "SecurePass123!",
  "profile": {
    "lang": "ru",
    "tz": "Europe/Moscow"
  },
  "group_names": ["customer"]
}
```
### –û—Ç–≤–µ—Ç:
```commandline
{
  "access_token": "eyJ...",
  "refresh_token": "r3fr3sh-t0k3n...",
  "token_type": "bearer"
}
```
‚úÖ –í—Å—ë –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—ë—Ç—Å—è ‚Üí –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏ –≥—Ä—É–ø–ø—ã —Å–≤—è–∑—ã–≤–∞—é—Ç—Å—è ‚Üí refresh-—Ç–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.  

## –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å accounts
–°–µ—Ä–≤–∏—Å auth –≤—ã–∑—ã–≤–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ —Å—Ö–µ–º—ã accounts:  

üîí –í—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ accounts ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏–∏, –Ω–∏–∫–∞–∫–∏—Ö –ø—Ä—è–º—ã—Ö SQL-–∑–∞–ø—Ä–æ—Å–æ–≤.  

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
1. –ü–∞—Ä–æ–ª–∏: —Ö–µ—à–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ bcrypt (cost=12)  
2. Refresh-—Ç–æ–∫–µ–Ω—ã:  
   - –•—Ä–∞–Ω—è—Ç—Å—è –≤ –ë–î —Ç–æ–ª—å–∫–æ –≤ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ (SHA-256)  
   - –ü—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ç–æ–∫–µ–Ω —Ö–µ—à–∏—Ä—É–µ—Ç—Å—è –∏ —Å–≤–µ—Ä—è–µ—Ç—Å—è —Å –ë–î  
3. Access-—Ç–æ–∫–µ–Ω—ã:  
   - –°—Ä–æ–∫ –∂–∏–∑–Ω–∏: 30 –º–∏–Ω—É—Ç (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)  
   - –ü–æ–¥–ø–∏—Å—å: HS256 —Å —Å–µ–∫—Ä–µ—Ç–æ–º –∏–∑ .env  
4. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:  
   - Email ‚Üí lower() 
   - –¢–µ–ª–µ—Ñ–æ–Ω ‚Üí +7... (–∏–∑ 8... –∏–ª–∏ 7...)

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (.env)
–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
```commandline
POSTGRES_USER=
POSTGRES_PASSWORD=
POSTGRES_HOST=
POSTGRES_DB=mydb
REDIS_HOST=  # (—Ä–µ–∑–µ—Ä–≤, –ø–æ–∫–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
JWT_SECRET_KEY=  # –¥–ª–∏–Ω–Ω—ã–π —Å–µ–∫—Ä–µ—Ç
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=30
```

## –ó–∞–ø—É—Å–∫
```commandline
uvicorn app.main:app --host 0.0.0.0 --port 8001 --reload
```
–ò–ª–∏ (–µ—Å–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω if __name__ == "__main__" –≤ main.py):  
```commandline
python -m app.main
```

## –î–∞–ª—å–Ω–µ–π—à–µ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ  
1. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ passwordless-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (SMS/email –∫–æ–¥—ã)  
2. –í—ã–¥–∞—á–∞ –Ω–æ–≤–æ–≥–æ refresh-—Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏  
3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Redis –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —á—ë—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤  
4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–≤ RabbitMQ)  